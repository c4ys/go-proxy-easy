name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        check-latest: true
    
    - name: Verify Go installation
      run: go version
    
    - name: Run tests
      run: go test -v ./...
    
    - name: Build binaries
      run: |
        mkdir -p dist
        
        # Get version info
        VERSION=${GITHUB_REF#refs/tags/}
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        GIT_COMMIT=${GITHUB_SHA::7}
        
        echo "Building version: $VERSION"
        echo "Build time: $BUILD_TIME"
        echo "Git commit: $GIT_COMMIT"
        
        # Build for different platforms
        platforms=("linux/amd64" "linux/arm64" "windows/amd64" "darwin/amd64" "darwin/arm64")
        
        for platform in "${platforms[@]}"; do
          IFS='/' read -r os arch <<< "$platform"
          output_name="go-proxy-easy"
          
          if [ "$os" = "windows" ]; then
            output_name="${output_name}.exe"
          fi
          
          output_path="dist/${output_name//go-proxy-easy/go-proxy-easy-$os-$arch}"
          if [ "$os" = "windows" ]; then
            output_path="dist/go-proxy-easy-${os}-${arch}.exe"
          else
            output_path="dist/go-proxy-easy-${os}-${arch}"
          fi
          
          echo "Building $os/$arch -> $output_path"
          GOOS=$os GOARCH=$arch go build -o "$output_path" main.go
        done
        
        echo "Build complete:"
        ls -la dist/
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/*
        body: |
          ## go-proxy-easy ${{ github.ref_name }}
          
          ä¸€ä¸ªæç®€çš„ Go HTTP ä»£ç†æœåŠ¡å™¨ï¼Œä¸€è¡Œå‘½ä»¤å³å¯å¯åŠ¨ï¼
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼Œç„¶åè¿è¡Œï¼š
          
          ```bash
          # æ— éœ€è®¤è¯
          ./go-proxy-easy
          
          # å¯ç”¨è®¤è¯
          ./go-proxy-easy -listen 0.0.0.0:8080 -user admin -pass 123456
          ```
          
          ### ğŸ“¦ ä¸‹è½½
          
          - **Linux**: `go-proxy-easy-linux-amd64` (x86_64) æˆ– `go-proxy-easy-linux-arm64` (ARM64)
          - **Windows**: `go-proxy-easy-windows-amd64.exe` (x86_64)
          - **macOS**: `go-proxy-easy-darwin-amd64` (Intel) æˆ– `go-proxy-easy-darwin-arm64` (Apple Silicon)
          
          ### âœ¨ ç‰¹æ€§
          
          - âœ¨ ä½¿ç”¨ Go 1.24 æ„å»ºï¼Œæ€§èƒ½ä¼˜åŒ–
          - ğŸ” æ”¯æŒ Basic è®¤è¯
          - ğŸŒ HTTP/HTTPS ä»£ç†æ”¯æŒ
          - ğŸª¶ è½»é‡çº§ï¼Œæ— å¤–éƒ¨ä¾èµ–
          - âš™ï¸ çµæ´»çš„å‘½ä»¤è¡Œé…ç½®
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
